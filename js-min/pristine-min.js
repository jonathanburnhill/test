import{lang}from"./lang";import{tmpl,findAncestor,groupedElemCount,mergeConfig}from"./utils";let defaultConfig={classTo:"form-group",errorClass:"has-danger",successClass:"has-success",errorTextParent:"form-group",errorTextTag:"div",errorTextClass:"text-help"};const PRISTINE_ERROR="pristine-error",SELECTOR="input:not([type^=hidden]):not([type^=submit]), select, textarea",ALLOWED_ATTRIBUTES=["required","min","max","minlength","maxlength","pattern"],validators={},_=function(e,t){t.name=e,t.msg||(t.msg=lang[e]),void 0===t.priority&&(t.priority=1),validators[e]=t};_("text",{fn:e=>!0,priority:0}),_("required",{fn:function(e){return"radio"===this.type||"checkbox"===this.type?groupedElemCount(this):void 0!==e&&""!==e},priority:99,halt:!0}),_("email",{fn:e=>!e||/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)}),_("number",{fn:e=>!e||!isNaN(parseFloat(e)),priority:2}),_("integer",{fn:e=>e&&/^\d+$/.test(e)}),_("minlength",{fn:(e,t)=>!e||e.length>=parseInt(t)}),_("maxlength",{fn:(e,t)=>!e||e.length<=parseInt(t)}),_("min",{fn:function(e,t){return!e||("checkbox"===this.type?groupedElemCount(this)>=parseInt(t):parseFloat(e)>=parseFloat(t))}}),_("max",{fn:function(e,t){return!e||("checkbox"===this.type?groupedElemCount(this)<=parseInt(t):parseFloat(e)<=parseFloat(t))}}),_("pattern",{fn:(e,t)=>{let r=t.match(new RegExp("^/(.*?)/([gimy]*)$"));return!e||new RegExp(r[1],r[2]).test(e)}});export default function Pristine(e,t,r){let n=this;function i(e,t,r,n){let i=validators[r];if(i&&(e.push(i),n)){let e=n.split(",");e.unshift(null),t[r]=e}}function s(e){let t=[],r=!0;for(let n in e.validators){let i=e.validators[n],s=e.params[i.name]?e.params[i.name]:[];if(s[0]=e.input.value,!i.fn.apply(e.input,s)){r=!1;let n=e.messages[i.name]||i.msg;if(t.push(tmpl.apply(n,s)),!0===i.halt)break}}return e.errors=t,r}function o(e){if(e.errorElements)return e.errorElements;let t=findAncestor(e.input,n.config.classTo),r=null,i=null;return(r=n.config.classTo===n.config.errorTextParent?t:t.querySelector(n.errorTextParent))&&((i=r.querySelector("."+PRISTINE_ERROR))||((i=document.createElement(n.config.errorTextTag)).className=PRISTINE_ERROR+" "+n.config.errorTextClass,r.appendChild(i),i.pristineDisplay=i.style.display)),e.errorElements=[t,i]}function a(e){let t=o(e),r=t[0],i=t[1];r&&(r.classList.remove(n.config.successClass),r.classList.add(n.config.errorClass)),i&&(i.innerHTML=e.errors.join("<br/>"),i.style.display=i.pristineDisplay||"")}function l(e){let t=function(e){let t=o(e),r=t[0],i=t[1];return r&&(r.classList.remove(n.config.errorClass),r.classList.remove(n.config.successClass)),i&&(i.innerHTML="",i.style.display="none"),t}(e)[0];t&&t.classList.add(n.config.successClass)}return function(e,t,r){e.setAttribute("novalidate","true"),n.form=e,n.config=mergeConfig(t||{},defaultConfig),n.live=!(!1===r),n.fields=Array.from(e.querySelectorAll(SELECTOR)).map(function(e){let t=[],r={},s={};return[].forEach.call(e.attributes,function(e){if(/^data-pristine-/.test(e.name)){let n=e.name.substr(14);if(n.endsWith("-message"))return void(s[n.slice(0,n.length-8)]=e.value);"type"===n&&(n=e.value),i(t,r,n,e.value)}else~ALLOWED_ATTRIBUTES.indexOf(e.name)?i(t,r,e.name,e.value):"type"===e.name&&i(t,r,e.value)}),t.sort((e,t)=>t.priority-e.priority),n.live&&e.addEventListener(~["radio","checkbox"].indexOf(e.getAttribute("type"))?"change":"input",function(e){n.validate(e.target)}.bind(n)),e.pristine={input:e,validators:t,params:r,messages:s,self:n}}.bind(n))}(e,t,r),n.validate=function(e,t){t=e&&!0===t||!0===e;let r=n.fields;!0!==e&&!1!==e&&(e instanceof HTMLElement?r=[e.pristine]:(e instanceof NodeList||e instanceof(window.$||Array)||e instanceof Array)&&(r=Array.from(e).map(e=>e.pristine)));let i=!0;for(let e in r){let n=r[e];s(n)?!t&&l(n):(i=!1,!t&&a(n))}return i},n.getErrors=function(e){if(!e){let e=[];for(let t=0;t<n.fields.length;t++){let r=n.fields[t];r.errors.length&&e.push({input:r.input,errors:r.errors})}return e}return e.length?e[0].pristine.errors:e.pristine.errors},n.addValidator=function(e,t,r,n,i){e instanceof HTMLElement?(e.pristine.validators.push({fn:t,msg:r,priority:n,halt:i}),e.pristine.validators.sort((e,t)=>t.priority-e.priority)):console.warn("The parameter elem must be a dom element")},n.addError=function(e,t){(e=e.length?e[0]:e).pristine.errors.push(t),a(e.pristine)},n.reset=function(){for(let e in n.fields)n.fields[e].errorElements=null;Array.from(n.form.querySelectorAll("."+PRISTINE_ERROR)).map(function(e){e.parentNode.removeChild(e)}),Array.from(n.form.querySelectorAll("."+n.config.classTo)).map(function(e){e.classList.remove(n.config.successClass),e.classList.remove(n.config.errorClass)})},n.destroy=function(){n.reset(),n.fields.forEach(function(e){delete e.input.pristine}),n.fields=[]},n.setGlobalConfig=function(e){defaultConfig=e},n}Pristine.addValidator=function(e,t,r,n,i){_(e,{fn:t,msg:r,priority:n,halt:i})};